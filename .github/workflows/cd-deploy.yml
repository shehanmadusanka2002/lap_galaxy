name: CD - Deploy to Production

on:
  push:
    branches: [ main ]
  workflow_dispatch:

env:
  AWS_REGION: us-east-1
  ECR_REGISTRY: ${{ secrets.ECR_REGISTRY }}
  BACKEND_IMAGE_NAME: lapgalaxy-backend
  FRONTEND_S3_BUCKET: ${{ secrets.S3_BUCKET_NAME }}

jobs:
  test:
    name: Run Tests
    runs-on: ubuntu-latest

    services:
      mysql:
        image: mysql:8.0
        env:
          MYSQL_ROOT_PASSWORD: 1234
          MYSQL_DATABASE: lapGalaxy
        ports:
          - 3306:3306
        options: >-
          --health-cmd="mysqladmin ping -h localhost"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=5

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        cache: maven

    - name: Run Backend Tests
      working-directory: ./backend
      env:
        SPRING_DATASOURCE_URL: jdbc:mysql://localhost:3306/lapGalaxy?createDatabaseIfNotExist=true&useSSL=false&allowPublicKeyRetrieval=true&serverTimezone=UTC
        SPRING_DATASOURCE_USERNAME: root
        SPRING_DATASOURCE_PASSWORD: 1234
      run: mvn test

    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        cache-dependency-path: frontend/package-lock.json

    - name: Install Frontend Dependencies
      working-directory: ./frontend
      run: npm install

    - name: Run Frontend Lint
      working-directory: ./frontend
      run: npm run lint || true

  build-backend:
    name: Build & Push Backend Docker Image
    needs: test
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        cache: maven

    - name: Build Backend JAR
      working-directory: ./backend
      run: mvn clean package -DskipTests

    - name: Configure AWS Credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ env.AWS_REGION }}

    - name: Login to Amazon ECR
      id: login-ecr
      uses: aws-actions/amazon-ecr-login@v2

    - name: Build, tag, and push Backend image to Amazon ECR
      working-directory: ./backend
      env:
        ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
        IMAGE_TAG: ${{ github.sha }}
      run: |
        docker build -t $ECR_REGISTRY/$BACKEND_IMAGE_NAME:$IMAGE_TAG .
        docker tag $ECR_REGISTRY/$BACKEND_IMAGE_NAME:$IMAGE_TAG $ECR_REGISTRY/$BACKEND_IMAGE_NAME:latest
        docker push $ECR_REGISTRY/$BACKEND_IMAGE_NAME:$IMAGE_TAG
        docker push $ECR_REGISTRY/$BACKEND_IMAGE_NAME:latest
        echo "IMAGE=$ECR_REGISTRY/$BACKEND_IMAGE_NAME:$IMAGE_TAG" >> $GITHUB_OUTPUT

  build-frontend:
    name: Build & Deploy Frontend to S3
    needs: test
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'

    - name: Install yarn
      run: npm install -g yarn

    - name: Install Dependencies with Yarn
      working-directory: ./frontend
      run: |
        yarn install --frozen-lockfile || yarn install

    - name: Build Frontend
      working-directory: ./frontend
      env:
        VITE_API_BASE_URL: ${{ secrets.BACKEND_API_URL }}
      run: npm run build

    - name: Configure AWS Credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ env.AWS_REGION }}

    - name: Deploy to S3
      working-directory: ./frontend
      run: |
        aws s3 sync dist/ s3://${{ env.FRONTEND_S3_BUCKET }} --delete --acl public-read

    - name: Invalidate CloudFront Cache
      if: ${{ secrets.CLOUDFRONT_DISTRIBUTION_ID != '' }}
      run: |
        aws cloudfront create-invalidation \
          --distribution-id ${{ secrets.CLOUDFRONT_DISTRIBUTION_ID }} \
          --paths "/*"

  deploy-backend:
    name: Deploy Backend to ECS/EC2
    needs: build-backend
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Configure AWS Credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ env.AWS_REGION }}

    # Option 1: Deploy to ECS (uncomment if using ECS)
    # - name: Deploy to Amazon ECS
    #   run: |
    #     aws ecs update-service \
    #       --cluster ${{ secrets.ECS_CLUSTER_NAME }} \
    #       --service ${{ secrets.ECS_SERVICE_NAME }} \
    #       --force-new-deployment

    # Option 2: Deploy to EC2 via SSH (uncomment if using EC2)
    - name: Deploy to EC2
      env:
        PRIVATE_KEY: ${{ secrets.EC2_SSH_PRIVATE_KEY }}
        HOST: ${{ secrets.EC2_HOST }}
        USER: ${{ secrets.EC2_USER }}
      run: |
        echo "$PRIVATE_KEY" > private_key.pem
        chmod 600 private_key.pem
        ssh -o StrictHostKeyChecking=no -i private_key.pem ${USER}@${HOST} << 'EOF'
          cd /opt/lapgalaxy
          docker pull ${{ secrets.ECR_REGISTRY }}/${{ env.BACKEND_IMAGE_NAME }}:latest
          docker-compose down
          docker-compose up -d
        EOF

  notify:
    name: Send Deployment Notification
    needs: [deploy-backend, build-frontend]
    runs-on: ubuntu-latest
    if: always()

    steps:
    - name: Deployment Success
      if: ${{ needs.deploy-backend.result == 'success' && needs.build-frontend.result == 'success' }}
      run: |
        echo "ðŸŽ‰ Deployment successful!"
        echo "Frontend: https://${{ env.FRONTEND_S3_BUCKET }}"
        echo "Backend: ${{ secrets.BACKEND_API_URL }}"

    - name: Deployment Failed
      if: ${{ needs.deploy-backend.result == 'failure' || needs.build-frontend.result == 'failure' }}
      run: |
        echo "âŒ Deployment failed!"
        exit 1
